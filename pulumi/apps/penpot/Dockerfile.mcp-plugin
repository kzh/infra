FROM node:22-bookworm-slim AS build

ARG PENPOT_REF=mcp-prod
ARG PENPOT_REPO=https://github.com/penpot/penpot.git
ARG WS_URI=wss://penpot-mcp-ws

WORKDIR /src

RUN apt-get update \
    && apt-get install -y --no-install-recommends ca-certificates git \
    && rm -rf /var/lib/apt/lists/*

RUN git clone --depth 1 --branch "${PENPOT_REF}" "${PENPOT_REPO}" penpot

WORKDIR /src/penpot/mcp

RUN corepack enable \
    && pnpm -r install

RUN WS_URI="${WS_URI}" pnpm --filter mcp-plugin run build


FROM nginx:1.27-alpine

COPY --from=build /src/penpot/mcp/packages/plugin/dist/ /usr/share/nginx/html/
COPY nginx.mcp-plugin.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
